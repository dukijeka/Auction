@model IEnumerable<AuctionsModel.Auction>

@{
    ViewBag.Title = "Index";
}

<h2>Auctions</h2>


@if (Request.IsAuthenticated)
{
    <p>
        @Html.ActionLink("Create New", "Create")
    </p>
}

<div class="card-columns">
    @foreach (var item in Model)
    {
        <div class="card bg-secondary">
            <div class="card-body">
                @*<h4 class="card-title">@Html.ActionLink(item.Name, "Details", item.ID)</h4>*@
                <h4 class="card-title"><a href="Auctions/Details/@item.ID">@item.Name</a></h4>
                <p class="card-img"><img src="/ShowImage.ashx?id=@item.ID" /></p>
                <p class="card-text" id="timer @item.ID">00:00:20</p>
                <p class="card-text">6.00$</p>
                <p class="card-text">lastBidder</p>
                <a href="#" class="btn btn-primary">Bid Now</a>
            </div>
        </div>

    }
</div>

@section scripts {
    <script>

        function sqlToJsDate(sqlDate) {
            //debugger;
        //sqlDate in SQL DATETIME format ("dd/mm/YYY hh:mm:ss [AM/PM]")
        var sqlDateArr1 = sqlDate.split("/");
        //format of sqlDateArr1[] = ['dd','mm','YYYY hh:mm:ss [AM/PM']]
        var sDay = sqlDateArr1[0];
        var sMonth = (Number(sqlDateArr1[1]) - 1).toString();
        var sqlDateArr2 = sqlDateArr1[2].split(" ");
        //format of sqlDateArr2[] = ['YYYY', 'hh:mm:ss', ['AM/PM']]
        var sYear = sqlDateArr2[0];
        var sqlDateArr3 = sqlDateArr2[1].split(":");
        //format of sqlDateArr3[] = ['hh','mm','ss']
        var sHour = sqlDateArr3[0]; 
        var sMinute = sqlDateArr3[1];
        var sSecond = sqlDateArr3[2];
        if (sqlDateArr2[2] == "PM") {
            sHour = "" + (Number(sHour) + 12);
        }
            var convertedDate = new Date(sYear, sMonth, sDay, sHour, sMinute, sSecond, 0);
            console.log("Inside method:");
            console.log("original date: " + sqlDate);

        console.log("converted Date: " + convertedDate);
        return convertedDate;

      // return new Date(sYear, sMonth, sDay, sHour, sMinute, sSecond, 0);

    }


    
    $(document).ready(function () {
        @foreach (var item in Model)
        {
            <text>

       // document.getElementById("timer @item.ID").innerHTML = countDownDate;
              
            </text>
        }
    });

    @foreach (var item in Model)
    {
        if (item.State == "OPENED")
        {
		    <text>
        var countDownDate = sqlToJsDate("@item.OppenedOn.AddSeconds(item.Duration)");
                //console.log(oppenedOn);
               // var expirationDate = oppenedOn.setSeconds(oppenedOn.getSeconds() + 20);
        

        @*var countDownDate = new Date(oppenedOn.getTime() + @item.Duration * 1000).getTime();*@
        console.log("outside method. Results: ")
        console.log("Original date: " + "@item.OppenedOn");
        console.log("Duration: " + "@item.Duration");
        console.log("converted date" + String(countDownDate));
        console.log("Now: " + String(new Date()));

                // Update the count down every 1 second
                var x = setInterval(function () {

                    // Get todays date and time
                    var now = new Date();

                    // Find the distance between now an the count down date
                    var distance = countDownDate.getTime() - now.getTime();

                    // Time calculations for days, hours, minutes and seconds
                    var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    var seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    // Display the result in the element
                    document.getElementById("timer @item.ID").innerHTML = days + "d " + hours + "h "
                     + minutes + "m " + seconds + "s ";

                    // If the count down is finished, write some text
                    if (distance < 0) {
                        clearInterval(x);
                        // document.getElementById("demo").innerHTML = "EXPIRED";
                    }
                }, 1000);
            </text>  
        }
    }

            
    </script>
}



